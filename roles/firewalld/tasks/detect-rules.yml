---

# TWG-CB-01-008-0245 Firewalld Configuration
- name: (TWG-CB-01-008-0245) Setup the rule description
  set_fact:
    rule_name: "firewalld服務"
  when: "'TWG-CB-01-008-0245' in rule_list"

- name: (TWG-CB-01-008-0245) Get firewalld configuration
  shell:
    systemctl list-unit-files --state=enabled | grep firewalld
  register: firewalld_status
  ignore_errors: true
  when: "'TWG-CB-01-008-0245' in rule_list"

- name: (TWG-CB-01-008-0245) Save results
  set_fact: 
    twgcb_results: |
      {{
        (twgcb_results | default([])) +
        [
          {
             'host': inventory_hostname,
             'rule_id': 'TWG-CB-01-008-0245',
             'rule_name': rule_name,
             'result': 'Failed' if firewalld_status.stdout == "" else 'Passed'
          }   
        ]
      }}
  delegate_to: localhost
  when: "'TWG-CB-01-008-0245' in rule_list"
  
# TWG-CB-01-008-0277 Disable SSH Root Login
- name: (TWG-CB-01-008-0277) Setup the rule description
  set_fact:
    rule_name: "SSH PermitRoot Login 參數"
  when: "'TWG-CB-01-008-0245' in rule_list"

- name: (TWG-CB-01-008-0277) Retrieve sshd configuration
  shell: 
     grep '^PermitRootLogin' /etc/ssh/sshd_config
  register: sshd_config
  ignore_errors: true
  when: "'TWG-CB-01-008-0277' in rule_list"

- name: (TWG-CB-01-008-0277) Setup result
  set_fact: 
    sshd_config_results: |
      {% if sshd_config.stdout != "" %}
        {% if (sshd_config.stdout.split('PermitRootLogin')[1] | trim ) != 'no' %}
        Failed
        {% else %}
        Passed
        {% endif %} 
      {% else %}       
      Passed 
      {% endif %} 
       
- name: (TWG-CB-01-008-0277) Save results
  set_fact: 
    twgcb_results: |
      {{
        (twgcb_results | default([])) +
        [
          {
             'host': inventory_hostname,
             'rule_id': 'TWG-CB-01-008-0277',
             'rule_name': rule_name,
             'result': (sshd_config_results | trim)
          }   
        ]
      }}
  delegate_to: localhost
  when: "'TWG-CB-01-008-0245' in rule_list"

- name: Combine to list
  set_fact: 
    all_test_results: "{{ all_test_results | default([]) + hostvars[item]['twgcb_results'] }}"
  with_items: "{{ groups[group_names[0]] }}"
     
- debug:
   msg: "{{ all_test_results }}"